<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Wirechat</title>

<style>
body {
    background:#0b0b0b;
    color:#ddd;
    font-family: monospace;
    margin:0;
    display:flex;
    flex-direction:column;
    height:100vh;
}

#top {
    padding:8px;
    background:#111;
    display:flex;
    gap:8px;
}

input, button {
    background:#1b1b1b;
    color:#ddd;
    border:1px solid #333;
    padding:6px;
}

button {
    cursor:pointer;
}

#chat {
    flex:1;
    overflow-y:auto;
    padding:10px;
    white-space:pre-wrap;
}

.sys { color:#3bd; }
.err { color:#f44; }
.nick { color:#4f4; }
.time { color:#777; }

.highlight {
    background:#333;
    color:#ffd700;
    padding:1px 3px;
    border-radius:3px;
}

#bottom {
    display:flex;
    gap:8px;
    padding:8px;
    background:#111;
}    
</style>
</head>

<body>

<div id="top">
    <input id="nick" placeholder="nickname">
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
</div>

<div id="chat"></div>

<div id="bottom">
    <input id="msg" placeholder="Type message or /command" style="flex:1">
    <button onclick="sendMsg()">Send</button>
</div>

<script>
let ws = null;
let nick = "";

const CLIENT_VERSION = "1.1.2";

const chat = document.getElementById("chat");
const nickInput = document.getElementById("nick");
const msgInput  = document.getElementById("msg");


// -------- load saved values --------

const savedNick = localStorage.getItem("wirechat_nick");
if (savedNick) {
    nickInput.value = savedNick;
}

const savedAdminToken = localStorage.getItem("wirechat_admin_token");


// -------- helpers --------

function addLine(html, cls="") {
    const div = document.createElement("div");
    if (cls) div.className = cls;
    div.innerHTML = html;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function escapeHTML(s){
    return s.replace(/[&<>"]/g, c => ({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        "\"":"&quot;"
    }[c]));
}


// -------- connection --------

function connect(){
    if (ws && ws.readyState === WebSocket.OPEN) return;

    nick = nickInput.value.trim();

    if (!nick){
        alert("Enter nickname");
        return;
    }

    localStorage.setItem("wirechat_nick", nick);

    ws = new WebSocket("wss://" + location.host + "/ws");

    ws.onopen = () => {
        addLine("Connected.", "sys");
        ws.send("NICK " + nick);

        if (savedAdminToken) {
            ws.send("ADMIN " + savedAdminToken);
        }
    };

    ws.onmessage = e => handleLine(e.data);

    ws.onclose = () => {
        addLine("Disconnected.", "sys");
    };

    ws.onerror = () => {
        addLine("Connection error.", "err");
    };
}

function disconnect(){
    if (ws){
        ws.close();
        ws = null;
    }
}


// -------- message handling --------

function handleLine(line){

    if (line.startsWith("SYS")){
        addLine(escapeHTML(line), "sys");
        return;
    }

    if (line.startsWith("ERR")){
        addLine(escapeHTML(line), "err");
        return;
    }

    if (line.startsWith("IMG ")){
        const rest = line.slice(4);

        // format: [timestamp] nick url
        const match = rest.match(/^\[(.*?)\] (.*?) (.*)$/);

        if (!match){
            addLine(escapeHTML(rest));
            return;
        }

        const time   = escapeHTML(match[1]);
        const sender = escapeHTML(match[2]);
        const url    = escapeHTML(match[3]);

        addLine(
            `<span class="time">[${time}]</span> ` +
            `<span class="nick">${sender}</span>: ` +
            `<img src="${url}" style="max-width:300px; display:block; margin-top:4px;">`
        );

        return;
    }

    if (line.startsWith("MSG ")){
        const rest = line.slice(4);

        // format: [timestamp] nick: text
        const match = rest.match(/^\[(.*?)\] (.*?): (.*)$/);

        if (match){
            const time = escapeHTML(match[1]);
            const sender = escapeHTML(match[2]);

            let text = escapeHTML(match[3]);

            // ---- nickname highlight ----
            if (nick) {
                const re = new RegExp(`\\b${nick}\\b`, "gi");
                text = text.replace(re, `<span class="highlight">${nick}</span>`);
            }

            addLine(
                `<span class="time">[${time}]</span> ` +
                `<span class="nick">${sender}</span>: ` +
                text
            );
        } else {
            addLine(escapeHTML(rest));
        }
        return;
    }

    addLine(escapeHTML(line));
}


// -------- sending --------

function sendMsg(){
    if (!ws || ws.readyState !== WebSocket.OPEN) return;

    const text = msgInput.value.trim();
    if (!text) return;

    // ---- local commands ----

    if (text === "/clear") {
        chat.innerHTML = "";
        msgInput.value = "";
        return;
    }

    if (text === "/version") {
        addLine(`LOCALSYS Wirechat browser client v${CLIENT_VERSION}`, "sys");
        ws.send("VERSION");
        msgInput.value = "";
        return;
    }

    if (text.startsWith("/admin ")) {
        const token = text.slice(7).trim();
        if (token) {
            localStorage.setItem("wirechat_admin_token", token);
            ws.send("ADMIN " + token);
        }
        msgInput.value = "";
        return;
    }

    if (text.startsWith("/img ")) {
        const url = text.slice(5).trim();
        if (url) ws.send("IMG " + url);
        msgInput.value = "";
        return;
    }

    // ---- server commands / messages ----

    if (text.startsWith("/")) {
        const parts = text.substring(1).trim().split(/\s+/);
        const cmd = parts[0].toUpperCase();
        const args = parts.slice(1).join(" ");
    
        ws.send(args ? `${cmd} ${args}` : cmd);
    } else {
        ws.send("MSG " + text);
    }

    msgInput.value = "";
}


// -------- enter key --------

msgInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMsg();
});

chat.addEventListener("click", e => {
    if (e.target.tagName === "IMG") {

        const current = e.target.style.maxWidth;

        // toggle between normal and small thumbnail
        if (current === "300px") {
            e.target.style.maxWidth = "120px";   // shrink size (adjust if you want)
        } else {
            e.target.style.maxWidth = "300px";   // normal size
        }
    }
});
</script>

</body>
</html>
